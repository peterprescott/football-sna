---
jupyter:
  jupytext:
    formats: ipynb,Rmd
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.4.2
  kernelspec:
    display_name: R
    language: R
    name: ir
---

# Executive Summary


# Introduction

```{r}
library(plyr) # data manipulation @HWickham2009
library(dplyr) # data manipulation @HWickham@2017
library(knitr) # dynamic report generation @YXie2012
library(igraph) # for graph/network analysis @GCsardiTNepusz2006
library(ggraph) # graph visualization in the style of ggplot @TPederson2016a
library(netrankr) # network centrality @DSchoch2015
library(ggplot2) # for plotting visualizations @HWickham2007
library(ggforce) # adds functionality to ggplot2, eg. geom_circle @TPederson2016b
library(ggrepel) # adds 'repellent' non-overlapping labels to ggplot @KSlowikowski2016
library(pheatmap) # prettier heat maps
library(RColorBrewer) # color palettes
library(docstring) # allows ?help to display function descriptions analogous to Pythonic docstrings
```

```{r}
DrawPitch <- function(lengthPitch=105, widthPitch=68, arrow=c("none", "r", "l"), theme=c("light", "dark", "grey", "grass")) {
    #' Draw regulation football pitch with penalty areas and centre circle.
    #' Adapted from https://github.com/JoGall/soccermatics
  
  # define colours by theme
  if(theme[1] == "grass") {
    fill1 <- "#008000"
    fill2 <- "#328422"
    colPitch <- "grey85"
    arrowCol <- "white"
    colText <- "white"
  } else if(theme[1] == "light") {
    fill1 <- "grey98"
    fill2 <- "grey98"
    colPitch <- "grey60"
    arrowCol = "black"
    colText <- "black"
  } else if(theme[1] %in% c("grey", "gray")) {    
    fill1 <- "#A3A1A3"
    fill2 <- "#A3A1A3"
    colPitch <- "white"
    arrowCol <- "white"
    colText <- "black"
  } else if(theme[1] == "dark") {  
    fill1 <- "#1C1F26"
    fill2 <- "#1C1F26"
    colPitch <- "white"
    arrowCol <- "white"
    colText <- "white"
  } else if(theme[1] == "blank") {
    fill1 <- "white"
    fill2 <- "white"
    colPitch <- "white"
    arrowCol <- "black"
    colText <- "black"
  }
  lwd <- 0.5
  
  border <- c(5, 5, 5, 5)
      
  # mowed grass lines
  lines <- (lengthPitch + border[2] + border[4]) / 13
  boxes <- data.frame(start = lines * 0:12 - border[4], end = lines * 1:13 - border[2])[seq(2, 12, 2),]
  
  # draw pitch
  p <- ggplot() +
    # background
    geom_rect(aes(xmin = -border[4], xmax = lengthPitch + border[2], ymin = -border[3], ymax = widthPitch + border[1]), fill = fill1) +
    # mowed pitch lines
    geom_rect(data = boxes, aes(xmin = start, xmax = end, ymin = -border[3], ymax = widthPitch + border[1]), fill = fill2) +
    # perimeter line
    geom_rect(aes(xmin = 0, xmax = lengthPitch, ymin = 0, ymax = widthPitch), fill = NA, col = colPitch, lwd = lwd) +
    # centre circle
    geom_circle(aes(x0 = lengthPitch/2, y0 = widthPitch/2, r = 9.15), col = colPitch, lwd = lwd) +
    # kick off spot
    geom_circle(aes(x0 = lengthPitch/2, y0 = widthPitch/2, r = 0.25), fill = colPitch, col = colPitch, lwd = lwd) +
    # halfway line
    geom_segment(aes(x = lengthPitch/2, y = 0, xend = lengthPitch/2, yend = widthPitch), col = colPitch, lwd = lwd) +
    # penalty arcs
    geom_arc(aes(x0= 11, y0 = widthPitch/2, r = 9.15, start = pi/2 + 0.9259284, end = pi/2 - 0.9259284), col = colPitch, lwd = lwd) +
    geom_arc(aes(x0 = lengthPitch - 11, y0 = widthPitch/2, r = 9.15, start = pi/2*3 - 0.9259284, end = pi/2*3 + 0.9259284), 
             col = colPitch, lwd = lwd) +
    # penalty areas
    geom_rect(aes(xmin = 0, xmax = 16.5, ymin = widthPitch/2 - 20.15, ymax = widthPitch/2 + 20.15), fill = NA, col = colPitch, lwd = lwd) +
    geom_rect(aes(xmin = lengthPitch - 16.5, xmax = lengthPitch, ymin = widthPitch/2 - 20.15, ymax = widthPitch/2 + 20.15), 
              fill = NA, col = colPitch, lwd = lwd) +
    # penalty spots
    geom_circle(aes(x0 = 11, y0 = widthPitch/2, r = 0.25), fill = colPitch, col = colPitch, lwd = lwd) +
    geom_circle(aes(x0 = lengthPitch - 11, y0 = widthPitch/2, r = 0.25), fill = colPitch, col = colPitch, lwd = lwd) +
    # six yard boxes
    geom_rect(aes(xmin = 0, xmax = 5.5, ymin = (widthPitch/2) - 9.16, ymax = (widthPitch/2) + 9.16), fill = NA, col = colPitch, lwd = lwd) +
    geom_rect(aes(xmin = lengthPitch - 5.5, xmax = lengthPitch, ymin = (widthPitch/2) - 9.16, ymax = (widthPitch/2) + 9.16), 
              fill = NA, col = colPitch, lwd = lwd) +
    # goals
    geom_rect(aes(xmin = -2, xmax = 0, ymin = (widthPitch/2) - 3.66, ymax = (widthPitch/2) + 3.66), fill = NA, col = colPitch, lwd = lwd) +
    geom_rect(aes(xmin = lengthPitch, xmax = lengthPitch + 2, ymin = (widthPitch/2) - 3.66, ymax = (widthPitch/2) + 3.66), 
              fill = NA, col = colPitch, lwd = lwd) +
    coord_fixed() +
    theme(rect = element_blank(), 
          line = element_blank(),
          axis.text = element_blank(),
          axis.title = element_blank())
    
  # add arrow
  if(arrow[1] == "r") {
    p <- p + 
      geom_segment(aes(x = 0, y = -2, xend = lengthPitch / 3, yend = -2), 
                   colour = arrowCol, size = 1.5, arrow = arrow(length = unit(0.2, "cm"), type="closed"), linejoin='mitre')
  } else if(arrow[1] == "l") {
    p <- p + 
      geom_segment(aes(x = lengthPitch, y = -2, xend = lengthPitch / 3 * 2, yend = -2), 
                   colour = arrowCol, size = 1.5, arrow = arrow(length = unit(0.2, "cm"), type="closed"), linejoin='mitre')
  }
      
  return(p)
}
```

# Data

```{r}
LoadAndScaleData <- function(national_league) {
    #' Load preprocessed event logs for given national league.
    
    events <- read.csv(paste0('../data/processed/', national_league, '.csv'))

    x_scale <- 105
    y_scale <- 68

    events$location_x <- events$location_x/100 * x_scale
    events$target_x <- events$target_x/100 * x_scale

    events$location_y <- y_scale - (events$location_y/100 * y_scale)
    events$target_y <- y_scale - (events$target_y/100 * y_scale)
    
    return(events)
}

```

```{r}
events <- LoadAndScaleData('England')
```

```{r}
LeagueResults <- function(league){

    teams <- sort(unique(league$team))

    home_score <- matrix(0, nrow=20, ncol=20)
    colnames(home_score) <- teams
    rownames(home_score) <- teams

    away_score <- home_score

    league_table <- matrix(0, nrow=20, ncol=8)
    rownames(league_table) <- teams
    colnames(league_table) <- c('POS','PTS','W','D','L','GF','GA','GD')

    return(list(league_table, home_score, away_score))
}
```

```{r}

```

```{r}
v <- LeagueResults(events)
```

```{r}
hs <- v[[2]]
```

```{r}
league <- events
```

```{r}
teams <- sort(unique(league$team))

home_score <- matrix(0, nrow=20, ncol=20)
colnames(home_score) <- teams
rownames(home_score) <- teams

away_score <- home_score

league_table <- matrix(0, nrow=20, ncol=8)
rownames(league_table) <- teams
colnames(league_table) <- c('POS','PTS','W','D','L','GF','GA','GD')
```

```{r}
for m in unique(league$matchId){
    
    match <- league[league$matchId==m,]
    home_team <- unique(match[match$home_or_away=='Home']$team)
    away_team <- unique(match[match$home_or_away=='Away']$team)
    home_goals <- nrow(match[match$to_team=='Home Goal',])
    away_goals <- nrow(match[match$to_team=='Away Goal',])
    
    home_score[home_team, away_team] <- home_goals
    away_score[home_team, away_team] <- away_goals
    
    league_table[]
       
        league_table[team]
    }
    
    
}
```

```{r}
league_table
```

```{r}

```

```{r}
for (match in unique(events$matchId)){

    goals <- 0

}
```

```{r}

```

```{r}

```

```{r}
mId <- unique(events$matchId)[1]
```

```{r}
m <- events[events$matchId==mId,]
```

```{r}
home_goals <- m[m$to_team=='Home Goal',]
```

```{r}
away_goals <- m[m$to_team=='Away Goal',]
```

```{r}
home_goals <- matrix(0, nrow=20, ncol=20)
```

```{r}
away_goals <- matrix(0, nrow=20, ncol=20)
```

```{r}
colnames(home_goals) <- teams
```

```{r}
rownames(home_goals) <- teams
```

```{r}
home
```

```{r}
home_goals
```

```{r}
teams <- sort(unique(events$team))
```

```{r}
ShowMatchEvents <- function(events, match_id, team_name, home_or_away='Home', flip=F) {
    #' Visualize events on pitch for given match and team.
    
    # select match
    game <- events[events$matchId==match_id,]
    goals <- game[game$subEventName=='Goal',]
    
    # note teams
    teams <- unique(game$team)

    # limit events to team specified by name or home/away
    if(!missing(team_name)){
        game <- game[game$team==team_name,]
        home_or_away <- unique(game$home_or_away)
    } else {
        game <- game[game$home_or_away==home_or_away,]
        team_name <- unique(game$team)
    }
    
    # note opposition
    opposition <- teams[teams!=team_name]
    
    # get score
    team_score <- table(goals$team)[team_name]
    opposition_score <- table(goals$team)[opposition]
    
    # flip coordinates if desired
    if (flip==T) {
        game$location_x <- 105 - game$location_x
        game$location_y <- 68 - game$location_y
        direction_of_play = 'l'
    } else { 
        direction_of_play = 'r'
    }
    
    # limit attention to main events
    game_events <- game[game$eventName == 'Pass'| 
                        game$eventName == 'Shot' | 
                        game$eventName == 'On the Ball' | 
                        game$eventName == 'Challenge' | 
                        game$eventName == 'Free Kick',]

    # draw pitch
    p <- DrawPitch(theme='grey', arrow=direction_of_play) + 
        geom_point(data = game_events, 
               aes(location_x , location_y, fill=eventName, shape=eventName), pch=21, alpha=0.6, size=2 ) + 
        geom_point(data=game_events[game_events$subEventName=='Goal',], 
                   aes(location_x, location_y), shape=13, size=5) +
        geom_label_repel(data=game_events[game_events$subEventName=='Goal',], 
                         aes(location_x, location_y, label = paste0(source,'(',matchPeriod,' ',time,')')), label.padding=0.1, size=2.3, alpha=1) +
        theme(legend.direction='horizontal', legend.position=c(0.5,0)) +
        scale_fill_manual(values=c("red", "black", 'white', "yellow", 'blue'), name='Event Type') +
        ggtitle(paste('Event Map:', team_name,'playing',home_or_away,'versus',opposition,'(',team_score,'-',opposition_score,')'))
    
    return(p)
    
}
```

```{r}
match_id <- '2500032'
```

```{r}
ShowMatchEvents(events, match_id, home_or_away='Home')
ShowMatchEvents(events, match_id, home_or_away='Away', flip=T)
```

```{r}
ShowPassesAndShots <- function(events, match_id, team_name, home_or_away='Home', flip=F) {
    #' Visualize passes on pitch for given match and team.
    
    # select match
    game <- events[events$matchId==match_id,]
    goals <- game[game$subEventName=='Goal',]
    
    # note teams
    teams <- unique(game$team)

    # limit events to team specified by name or home/away
    if(!missing(team_name)){
        game <- game[game$team==team_name,]
        home_or_away <- unique(game$home_or_away)
    } else {
        game <- game[game$home_or_away==home_or_away,]
        team_name <- unique(game$team)
    }
    
    # note opposition
    opposition <- teams[teams!=team_name]
    
    # get score
    team_score <- table(goals$team)[team_name]
    opposition_score <- table(goals$team)[opposition]
    
    # flip coordinates if desired
    if (flip==T) {
        game$location_x <- 105 - game$location_x
        game$target_x <- 105 - game$target_x
        game$location_y <- 68 - game$location_y
        game$target_y <- 68 - game$target_y
        direction_of_play = 'l'
    } else { 
        direction_of_play = 'r'
    }
    
    # limit attention to passes and shots
    passes <- game[game$eventName == 'Pass' & game$team == team_name,]
    shots <- game[(game$eventName=='Shot' | game$subEventName=='Goal') & game$team==team_name,]
    
    # draw pitch
    p <- DrawPitch(theme='grass', arrow=direction_of_play) + 
        geom_segment(data=na.exclude(passes), 
                     aes(x=location_x, y=location_y, xend=target_x, yend=target_y, color=subEventName), 
                     alpha=0.6, arrow = arrow(length = unit(0.1,"cm"))) +
        geom_label_repel(data=game[game$subEventName=='Goal',], 
                     aes(location_x, location_y, label = paste0(source,'(',matchPeriod,' ',time,')')), label.padding=0.1, size=2.3, alpha=1) + 
        geom_segment(data=na.exclude(shots), 
                 aes(x=location_x, y=location_y, xend=target_x, yend=target_y, color=subEventName), 
                 alpha=0.7, arrow = arrow(length = unit(0.1,"cm"))) +
        theme(legend.position=c(0.5,-0.01), legend.direction='horizontal',
              legend.background=element_rect(fill='#008000', linetype='solid')) +
        scale_color_manual(values=c("red", "black", 'blue', 'orange', "yellow", 'grey', 'purple', 'white','brown'), name='Pass Type') +
        ggtitle(paste('Pass Map:',team_name,'playing',home_or_away,'versus',opposition,'(',team_score,'-',opposition_score,')'))
    
    return(p)
} 
```

```{r}
ShowPassesAndShots(events, match_id, home_or_away='Home')
ShowPassesAndShots(events, match_id, home_or_away='Away', flip=T)
```

# Methodology

```{r}
PassNetwork <- function(events, match_id, team_name, team_colour='red', home_or_away='Home', flip=F, lower_threshold=1, high_threshold=10) {
    #' Draw Pass Map of First XI with nodes placed on mean (x,y) pitch-coordinates.

    game <- events[events$matchId == match_id,]
    goals <- game[game$subEventName=='Goal',]
    
    # note teams
    teams <- unique(game$team)

    # limit events to team specified by name or home/away
    if(!missing(team_name)){
        game <- game[game$team==team_name,]
        home_or_away <- unique(game$home_or_away)
    } else {
        game <- game[game$home_or_away==home_or_away,]
        team_name <- unique(game$team)
    }
    
    # note opposition
    opposition <- teams[teams!=team_name]
    
    # get score
    team_score <- table(goals$team)[team_name]
    opposition_score <- table(goals$team)[opposition]
    
    
    firstXI <- game[game$FirstXI == 'True',]
    mean_positions <- firstXI[firstXI$location_x>0 & firstXI$location_y>0 & firstXI$location_x<105 & firstXI$location_y<68,] %>% 
        group_by(team, matchId, source) %>%
          dplyr::summarise(x_mean = mean(location_x), y_mean = mean(location_y)) %>% 
          ungroup() %>%
          mutate(team = as.factor(team), id = as.factor(matchId)) %>%
          as.data.frame()


    pass_counts <- ddply(data.frame(game$source, game$target),.(game.source,game.target),nrow)
    names(pass_counts) <- c('source','target','passcount')
    step1 <- merge(mean_positions, pass_counts, by='source')
    step2 <- step1[,c(1,4,5,7,8)]
    names(step2)[2:3] <- c('source_x','source_y')
    names(mean_positions)[3] <- 'target'
    step3 <- merge(mean_positions, step2, by='target')
    team <- step3[step3$team==team_name,]

    if (flip==T) {
        team$source_x <- 105 - team$source_x
        team$x_mean <- 105 - team$x_mean
        team$source_y <- 68 - team$source_y
        team$y_mean <- 68 - team$y_mean
        mean_positions$x_mean <- 105 - mean_positions$x_mean
        mean_positions$y_mean <- 68 - mean_positions$y_mean
    }

    return (DrawPitch() +
        geom_segment(data=team[team$passcount>=lower_threshold,], size=1, colour=team_colour,
                     aes(x=source_x, y=source_y, xend=x_mean, yend=y_mean, alpha=passcount)) +
        geom_segment(data=team[team$passcount>=high_threshold,], size=1.5, colour='black',
                     aes(x=source_x, y=source_y, xend=x_mean, yend=y_mean, alpha=passcount)) +
        geom_label_repel(data = mean_positions[mean_positions$team==team_name,], 
                         aes(x_mean, y_mean, label = target), label.padding=0.1, size=2.3, alpha=1) +
        geom_point(data=team, aes(x_mean, y_mean,), fill=team_colour, colour='black', pch=21, size=3) +
        ggtitle(paste('Passing Network:',team_name,'playing',home_or_away,'versus',opposition,'(',team_score,'-',opposition_score,')')) +
        theme(legend.position=c(0.5,0.07), legend.direction='horizontal'))
    
}
```

```{r}
PassNetwork(events, match_id, team_colour='blue')
PassNetwork(events, match_id, home_or_away='Away', flip=T)
```

```{r}
GameGraph <- function(events, match_id, team_name, home_or_away='Home') {
    #' Return Possession Graph for given Match and Team.
    
    game <- events[events$matchId == match_id,]
    game <- game[game$source!='' & game$target!='nan',]
    
     # note teams
    teams <- unique(game$team)

    # limit events to team specified by name or home/away
    if(!missing(team_name)){
        team_game <- game[game$team==team_name,]
        home_or_away <- unique(team_game$home_or_away)
    } else {
        team_game <- game[game$home_or_away==home_or_away,]
        team_name <- as.character(unique(team_game$team))
    }

    opposition_game <- game[game$team != team_name,]
    opposition_team <- as.character(unique(opposition_game$team))

    team_nodes <- unique(c(as.character(team_game$source),as.character(team_game$target)))
    team_edges <- data.frame(team_game$source, team_game$target)
    team_graph <- graph_from_data_frame(d=team_edges, vertices=team_nodes, directed=TRUE)
    team_adj <- as.matrix(team_graph[])

    possession_seqs <- unique(team_game$possession)

    seq_start <- c()

    for (pseq in possession_seqs){
        if (sum(team_game$possession==pseq)>1){
            player <- as.character(team_game[team_game$possession==pseq,][1,]$source)
            if (player!='' & player!='nan'){
                seq_start <- append(seq_start, player)
            }
        }
    }

    start_counts <- table(as.factor(seq_start))

    for (i in (2:(length(start_counts)-1))){
        team_adj[nrow(team_adj)-1,][names(start_counts[i])] <- as.numeric(start_counts[i])
    }

    opposition_status <- as.character(unique(opposition_game$home_or_away))
    opp_to_opp <- as.numeric(summary(game[game$team != team_name,]$to_team)[opposition_status])

    opp_nodes <- unique(c(as.character(opposition_game$source),as.character(opposition_game$target)))
    opp_edges <- data.frame(opposition_game$source, opposition_game$target)
    opp_graph <- graph_from_data_frame(d=opp_edges, vertices=opp_nodes, directed=TRUE)
    opp_adj <- as.matrix(opp_graph[])

    opp_to_opp <- sum(opp_adj[,ncol(opp_adj)-1])
    team_adj[(nrow(team_adj)-1),(ncol(team_adj)-1)] <- opp_to_opp

    team_status <- unique(team_game$home_or_away)
    opposition_own_goals <- as.numeric(nrow(game[game$home_or_away==opposition_status & game$to_team==paste(team_status,'Goal'),]))
    team_adj[(nrow(team_adj)-1),(ncol(team_adj))] <- opposition_own_goals

    team_graph <- graph_from_adjacency_matrix(team_adj, mode='directed')

    return(team_graph)
}
```

```{r}
AdjacencyMatrix <- function(graph){
    #' Return Adjacency Matrix for Graph
    
    return(as.matrix(graph[]))
}
```

```{r}
TransitionMatrix <- function(graph){
    #' Return Transition Matrix for Graph considered as time-homogeneous Markov Process
    
    matrix <- as.matrix(graph[])

    for (i in 1:nrow(matrix)){
        matrix[i,] <- matrix[i,]/sum(matrix[i,])
    }

    matrix[nrow(matrix),ncol(matrix)] <- 1
    matrix[nrow(matrix),] <- rep(0, ncol(matrix))
    
    # treat 'Goal' as absorbtion state
    matrix[nrow(matrix),ncol(matrix)] <- 1
    
    return(matrix)
}
```

```{r}
ExpectedScoringTime <- function(transition_matrix){
    #' Calculate expected scoring time based on transition matrix.
    
    max_steps <- 10000
#     transition_matrix <- TransitionMatrix(GameGraph(events, match_id))
    hitting_times <- rep(0,(ncol(transition_matrix)-2))
   
    for (i in (1:(ncol(transition_matrix)-2))){
        
        state_probabilities <- matrix(NA,nrow=max_steps+1,ncol=ncol(transition_matrix),dimnames=list(0:max_steps,(ncol(transition_matrix)-1):0))
        vector <- rep(0,ncol(transition_matrix))
        
        vector[i] <- 1
        state_probabilities[1,] <- vector

        for ( kk in 1:max_steps ) {
            state_probabilities[kk+1,] <- t(transition_matrix)%*%state_probabilities[kk,]
        }

        probs <- diff(state_probabilities[,ncol(transition_matrix)])
        hitting_time <- sum(probs*seq_along(probs))
        
        hitting_times[i] <- hitting_time
    }
    
    names(hitting_times) <- names(transition_matrix[1,])[1:(nrow(transition_matrix)-2)]
    
    return(hitting_times)
   
}
```

```{r}
x_score_time <- ExpectedScoringTime(
    TransitionMatrix(
        GameGraph(events, match_id, home_or_away='Home'))

)
```

```{r}
x_score_time/mean(x_score_time)
```

```{r}
x_score_time/mean(x_score_time)
```

```{r}
names(transition_matrix[1,])[1:(nrow(transition_matrix)-2)]
```

```{r}
max_steps <- 10000
transition_matrix <- TransitionMatrix(GameGraph(events, match_id))
state_probabilities <- matrix(NA,nrow=max_steps+1,ncol=ncol(transition_matrix),dimnames=list(0:max_steps,(ncol(transition_matrix)-1):0))
vector <- rep(0,ncol(transition_matrix))
vector[6] <- 1
state_probabilities[1,] <- vector

for ( kk in 1:max_steps ) {
    state_probabilities[kk+1,] <- t(transition_matrix)%*%state_probabilities[kk,]
}

probs <- diff(state_probabilities[,ncol(transition_matrix)])
sum(probs*seq_along(probs))
```

```{r}
transition_matrix
```

```{r}
MatrixHeatMap <- function(matrix, number_format='%.d', title='Matrix Heatmap'){
    #' Show Matrix as HeatMap
    
    hm <- pheatmap(matrix,color=brewer.pal(15,'YlGnBu'),cluster_rows=F,cluster_cols=F,legend=F,
                    display_numbers=T,number_format=number_format,fontsize_number=9,angle_col='315',
                    main=title)   
    
    return(hm)
}
```

```{r}
MatrixHeatMap(
    AdjacencyMatrix(g)[1:11,1:11]

)
```

```{r}
MatrixHeatMap(
    AdjacencyMatrix(
        GameGraph(events, match_id, home_or_away='Away'))[1:11,1:11]
)
```

```{r}
MatrixHeatMap(
    TransitionMatrix(
        GameGraph(events, match_id, home_or_away='Home')), 
    number_format='%.2f',
    title=''
)
```

```{r}
MatrixHeatMap(
    TransitionMatrix(
        GameGraph(events, match_id, home_or_away='Away')), 
    number_format='%.2f',
    title=''
)
```

```{r}
GoalSeqs <- function(events, match_id) {
    match <- events[events$matchId==match_id,]
    goals <- match[match$subEventName=='Goal',]
    goal_seqs <- unique(goals$possession)   
    return(goal_seqs)
}
```

```{r}
TabulateSequence <- function(events, possession_sequence) {
    # Return a markdown table starting from the row before a possession sequence begins, and continuing until it ends.
    
    start <- min(events[events$possession == possession_sequence,]$X)
    stop <- max(events[events$possession == possession_sequence,]$X) + 1
    table <- events[start:stop,]
    df <- data.frame(table$matchPeriod, table$time, table$team, table$source, table$subEventName)
    names(df) <- c('Half', 'Time', 'Team', 'Event Description', 'Player')
    
    return(kable(df))
}
```

```{r}
sequence <- '2500032-91-Liv-0'
```

```{r}
TabulateSequence(events, sequence)
```

```{r}
SequenceOnPitch <- function(events, possession_sequence){
    #' Draw Possession Sequence on Pitch
    
    data <- events[events$possession == possession_sequence,]

    p <- DrawPitch(theme='grass') + 
        geom_label_repel(data = data, aes(location_x, location_y, label = paste(source,time)), label.padding=0.1, size=2.3, alpha=1) +
        geom_curve(data = data, aes(x = location_x, xend = target_x, y = location_y, yend = target_y*.99, col = X), 
                   show.legend=FALSE, size=1, alpha = 1) +
        geom_point(data = data, aes(location_x , location_y, shape=eventName), size=2) + 
        ggtitle(paste0(nrow(data),'-part ', unique(data$team)[1], ' Possession Sequence ending with ', 
                       data[nrow(data),]$subEventName, ' by ', data[nrow(data),]$source))  +
        theme(legend.position=c(0.5,0.08), legend.direction='horizontal', legend.title=element_blank())
    
    return(p)
}
```

```{r}
SequenceOnPitch(events, sequence)
```

youtube clip
<img src="../figures/youtube_clip.gif" width='700'>

```{r}
SequenceGraph <- function(events, possession_sequence){
    #' Return Graph of Possession Sequence
    
    data <- events[events$possession == possession_sequence,]
    data <- data[data$source!='' & data$target!='nan',]
    nodes <- unique(c(as.character(data$source),as.character(data$target)))
    edges <- data.frame(data$source, data$target)
    g <- graph_from_data_frame(d=edges, vertices=nodes, directed=TRUE)
    g$id <- possession_sequence
    g$data <- data
    g$team <- as.character(unique(data$team))
    
    return(g)
}
```

```{r}
VisualizeGraph <- function(possession_sequence_graph) {
    #' Visualize Possession Sequence as Linear Graph with Looping Edges
    
    g <- possession_sequence_graph
    data <- possession_sequence_graph$data
    
    visualization <- ggraph(g, 'linear') + 
        geom_edge_arc(aes(color=data$eventName), 
                      arrow=arrow(length=unit(4,'mm')), 
                      fold=F,
                     width=1) +
        geom_edge_loop(aes(color=data$eventName),
                      width=1) +
        geom_node_point(color='black', 
                        size=2,
                        alpha=0.5) +
        geom_node_text(aes(label = name), 
                        repel=T, 
                        angle=90, hjust=2, ) +
        scale_edge_colour_manual(
            values=c('indianred3', 'wheat4', 'grey', 'grey30',
                    'red','blue','green','orange','purple','brown','pink'
                    ),
            name='Event Type') +
        theme_void()
   
    return(visualization)
    
}
```

```{r}
g <- SequenceGraph(events, sequence)
```

```{r}
VisualizeGraph(g)
```

```{r}
GetGraphMetrics <- function(possession_graph) {
    #' Return basic metrics for given Graph
    
    g <- possession_graph
    path_metrics <- c(g$id, g$team, length(V(g)), length(E(g)), 
                      diameter(g), mean_distance(g), edge_density(g, loops=T), 
                      girth(g)$girth, transitivity(g), authority_score(g)$value, hub_score(g)$value)
    names(path_metrics) <- c('Label', 'Team', 'Nodes', 'Edges', 'Diameter', 'Mean_Distance', 
                             'Edge_Density', 'Girth', 'Transitivity', 'Authority_Score', 'Hub_Score')
    
    return(path_metrics)
}
```

```{r}
GetNodeMetrics <- function(possession_graph) {
    #' Return metrics for each Node of given Graph
    
    g <- possession_graph
    df <- data.frame(page_rank(g)$vector)
    names(df) <- 'pagerank'
    df$in_degree <- degree(g, mode='in')
    df$out_degree <- degree(g, mode='out')
    df$eccentricity <- eccentricity(g)
    df$closeness <- closeness(g)
    df$betweenness <- betweenness(g)
    df$norm_betweenness <- betweenness(g, normalized=T)
    df$alpha_centrality <- alpha_centrality(g)
    df$power_centrality <- power_centrality(g)
    df$eigen_centrality <- eigen_centrality(g)$vector
    df$authority <- authority_score(g)$vector
    df$hub <- hub_score(g)$vector
    
    return(df)
}
```

```{r}
GetEdgeMetrics <- function(possession_graph) {
    #' Return metrics for each Edge of given Graph
    
    g <- possession_graph
    df <- data.frame(as_edgelist(g))
    names(df) <- c('Source','Target')
    df$sequence <- 1:length(E(g))
    df$edge_betweenness <- edge_betweenness(g)
    
    return(df)
}
```

```{r}
GetGraphMetrics(g)
```

```{r}
GetNodeMetrics(match_graph)
```

```{r}
GetEdgeMetrics(g)
```

```{r}
sequence2 <- '2499858-18-Liv-5'
```

```{r}
TabulateSequence(sequence2)
```

```{r}
SequenceOnPitch(sequence2)
```

<img src='../figures/mane_vs_stoke.gif'>

```{r}
g2 <- SequenceGraph(sequence2)
VisualizeGraph(g2)
```

```{r}
GetGraphMetrics(g2)
```

```{r}
sequence3 <-  '2499889-18-Liv-0'
```

```{r}
SequenceOnPitch(sequence3)
```

```{r}
g3 <- SequenceGraph(sequence3)
VisualizeGraph(g3)
```

```{r}
GetGraphMetrics(g3)
```

<img src="../figures/youtube_clip2.gif">

```{r}

```
